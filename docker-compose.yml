version: '3.8'

services:
  redis:
    image: redis:7-alpine
    container_name: dishu-redis
    restart: always
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - dishu-network

  server:
    image: ghcr.io/syhien/dishu_game-server:latest
    container_name: dishu-server
    restart: always
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    ports:
      - "127.0.0.1:${SERVER_PORT:-13001}:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - HOST=0.0.0.0
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis
    networks:
      - dishu-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # å‰ç«¯æœåŠ¡ - å¦‚æœéœ€è¦è‡ªå®šä¹‰é…ç½®ï¼Œå–æ¶ˆæ³¨é‡Š build éƒ¨åˆ†è‡ªè¡Œæ„å»º
  web:
    # ä½¿ç”¨é¢„æ„å»ºé•œåƒï¼ˆé…ç½®å›ºå®šä¸ºé»˜è®¤å€¼ï¼‰
    image: ghcr.io/syhien/dishu_game-web:latest
    
    # å¦‚éœ€è‡ªå®šä¹‰åç§°/ä¸»é¢˜è‰²ï¼Œå–æ¶ˆä¸‹é¢æ³¨é‡Šè‡ªè¡Œæ„å»ºï¼š
    # build:
    #   context: ./apps/web
    #   args:
    #     - VITE_APP_NAME=${VITE_APP_NAME:-å˜€å’•æ¸¸æˆ}
    #     - VITE_APP_SUBTITLE=${VITE_APP_SUBTITLE:-åœ¨çº¿å¤šäººæ¸¸æˆå¹³å°}
    #     - VITE_APP_LOGO=${VITE_APP_LOGO:-ğŸ®}
    #     - VITE_THEME_PRIMARY=${VITE_THEME_PRIMARY:-#667eea}
    #     - VITE_THEME_SECONDARY=${VITE_THEME_SECONDARY:-#764ba2}
    
    container_name: dishu-web
    restart: always
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    ports:
      - "127.0.0.1:${WEB_PORT:-8080}:80"
    depends_on:
      - server
    networks:
      - dishu-network

  watchtower:
    image: containrrr/watchtower
    container_name: dishu-watchtower
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - dishu-network

volumes:
  redis_data:

networks:
  dishu-network:
    driver: bridge
